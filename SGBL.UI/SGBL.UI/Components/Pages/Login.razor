@page "/"

<PageTitle>Login</PageTitle>

@page "/login"

@using SGBL.Data.Models
@using SGBL.Data.Contexts
@using Microsoft.EntityFrameworkCore;
@using SGBL.UI.Components.Layout

@inject LibraryDbContext DbContext

@layout MainLayout

<h3>Inicio de Sesión</h3>

<div class="form-container">
    <EditForm Model="@loginModel" OnValidSubmit="HandleValidSubmit" FormName="loginForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label for="email">Email:</label>
            <InputText id="email" class="form-control" @bind-Value="loginModel.Email" />
        </div>
        <div class="mb-3">
            <label for="password">Password:</label>
            <InputText id="password" type="password" class="form-control" @bind-Value="loginModel.Password" />
        </div>
        <button class="btn btn-primary" type="submit">Login</button>
    </EditForm>
</div>

@code {
    private LoginModel loginModel = new LoginModel();

    private async Task HandleValidSubmit()
    {
        try
        {
            var user = await DbContext.Users
                .FirstOrDefaultAsync(u => u.Email == loginModel.Email);

            if (user == null)
            {
                Console.WriteLine("El usuario no existe");
                return;
            }

            if (!BCrypt.Net.BCrypt.Verify(loginModel.Password, user.Password))
            {
                Console.WriteLine("Contraseña incorrecta");
                return;
            }

            Console.WriteLine("Inicio de sesión exitoso: " + user.Name);
            // Aquí puedes agregar la lógica para redirigir al usuario o establecer su sesión
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error al iniciar sesión: " + ex.Message);
        }
    }

    public class LoginModel
    {
        public string Email { get; set; }
        public string Password { get; set; }
    }
}
